<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <title>åƒè¯æé†’ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, 'Microsoft YaHei', 'PingFang SC', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            padding-bottom: 80px; /* ä¸ºç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªç•™ç©ºé—´ */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            min-height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .header p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            flex-shrink: 0;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            flex: 1;
            min-width: 80px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            background: #f5f5f5;
            border: none;
            font-size: 0.9em;
            transition: all 0.3s;
            white-space: nowrap;
            touch-action: manipulation;
            position: relative;
        }

        .tab:active {
            background: #e0e0e0;
            transform: scale(0.98);
        }

        .tab.active {
            background: white;
            color: #667eea;
            font-weight: bold;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #667eea;
        }

        .content {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px; /* é˜²æ­¢iOSè‡ªåŠ¨ç¼©æ”¾ */
            transition: all 0.3s;
            background: white;
            touch-action: manipulation;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 14px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
            min-height: 44px; /* ç§»åŠ¨ç«¯æœ€å°è§¦æ‘¸ç›®æ ‡ */
            display: inline-block;
            text-align: center;
            width: 100%;
            margin: 5px 0;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            width: 100%;
        }

        .btn-group .btn {
            flex: 1;
            min-width: 120px;
        }

        .camera-container {
            margin: 20px 0;
            text-align: center;
        }

        #video {
            width: 100%;
            max-width: 100%;
            height: auto;
            max-height: 400px;
            border-radius: 10px;
            background: #000;
            display: none;
            object-fit: contain;
            cursor: pointer;
            opacity: 1;
            transform: scale(1);
        }

        #video.playing {
            opacity: 1;
        }

        #video.paused {
            opacity: 0.8;
        }

        #canvas {
            display: none;
        }

        .photo-preview {
            width: 100%;
            max-width: 100%;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .medicine-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .medicine-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 18px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
        }

        .medicine-card:active {
            transform: scale(0.98);
        }

        .medicine-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
            border-color: #667eea;
        }

        .medicine-card h3 {
            color: #667eea;
            margin-bottom: 12px;
            font-size: 1.2em;
            word-break: break-word;
        }

        .medicine-card img {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin: 12px 0;
        }

        .medicine-card .info {
            margin: 12px 0;
            color: #666;
            font-size: 0.9em;
            flex: 1;
        }

        .medicine-card .info p {
            margin: 8px 0;
            line-height: 1.5;
        }

        .medicine-card .actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .medicine-card .actions .btn {
            flex: 1;
            min-width: 100px;
            margin: 0;
            font-size: 0.9em;
            padding: 12px 16px;
        }

        .record-list {
            margin-top: 20px;
        }

        .record-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .record-item:active {
            transform: scale(0.98);
        }

        .record-item h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
            word-break: break-word;
        }

        .record-item img {
            max-width: 100%;
            width: 100%;
            border-radius: 8px;
            margin: 12px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .record-item .time {
            color: #666;
            font-size: 0.9em;
            margin: 8px 0;
        }

        .record-item p {
            margin: 8px 0;
            line-height: 1.5;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state p {
            font-size: 1em;
        }

        .reminder-badge {
            display: inline-block;
            background: #ff6b6b;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            margin-left: 8px;
            font-weight: 600;
        }

        .notification-permission {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .notification-permission p {
            margin-bottom: 12px;
            color: #856404;
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            body {
                padding: 5px;
                padding-bottom: 70px;
            }

            .container {
                border-radius: 15px;
                min-height: calc(100vh - 10px);
            }

            .header {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .header p {
                font-size: 0.85em;
            }

            .content {
                padding: 15px;
            }

            .tab {
                padding: 12px 8px;
                font-size: 0.85em;
            }

            .medicine-list {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .medicine-card {
                padding: 15px;
            }

            .medicine-card .actions {
                flex-direction: column;
            }

            .medicine-card .actions .btn {
                width: 100%;
            }

            .record-item {
                padding: 15px;
            }

            .form-group input,
            .form-group select {
                padding: 12px;
            }

            .btn {
                padding: 12px 20px;
                font-size: 0.95em;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn-group .btn {
                width: 100%;
                min-width: auto;
            }

            .camera-container {
                margin: 15px 0;
            }

            #video {
                max-height: 300px;
            }
        }

        /* å°å±å¹•æ‰‹æœºä¼˜åŒ– */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.3em;
            }

            .tab {
                padding: 10px 6px;
                font-size: 0.8em;
                min-width: 70px;
            }

            .content {
                padding: 12px;
            }

            .medicine-card h3 {
                font-size: 1.1em;
            }

            .record-item h4 {
                font-size: 1em;
            }
        }

        /* æ¡Œé¢ç«¯ä¼˜åŒ– */
        @media (min-width: 769px) {
            body {
                padding: 20px;
                padding-bottom: 20px;
            }

            .header {
                padding: 30px;
            }

            .header h1 {
                font-size: 2.2em;
            }

            .content {
                padding: 30px;
            }

            .tab {
                padding: 18px 15px;
                font-size: 1em;
            }

            .medicine-list {
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                gap: 20px;
            }

            .btn-group .btn {
                width: auto;
            }

            .medicine-card .actions .btn {
                width: auto;
            }
        }

        /* å¤§å±å¹•ä¼˜åŒ– */
        @media (min-width: 1200px) {
            .medicine-list {
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            }
        }

        /* æ¨ªå±ä¼˜åŒ– */
        @media (max-width: 768px) and (orientation: landscape) {
            .header {
                padding: 12px;
            }

            .header h1 {
                font-size: 1.3em;
                margin-bottom: 5px;
            }

            .tab {
                padding: 10px 8px;
            }

            .content {
                padding: 15px;
            }
        }

        /* æé†’å¼¹çª—åŠ¨ç”» */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        #pageReminder {
            animation: slideDown 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’Š åƒè¯æé†’ç³»ç»Ÿ</h1>
            <p>è®°å½•æ‚¨çš„ç”¨è¯æƒ…å†µï¼ŒæŒ‰æ—¶æé†’</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('add', this)">æ·»åŠ è¯ç‰©</button>
            <button class="tab" onclick="switchTab('list', this)">æˆ‘çš„è¯ç‰©</button>
            <button class="tab" onclick="switchTab('records', this)">ç”¨è¯è®°å½•</button>
            <button class="tab" onclick="switchTab('reminders', this)">æé†’è®¾ç½®</button>
        </div>

        <div class="content">
            <!-- æ·»åŠ è¯ç‰© -->
            <div id="add" class="tab-content active">
                <div class="notification-permission" id="notificationPermission" style="display: none;">
                    <p><strong>ğŸ“± å¯ç”¨æé†’åŠŸèƒ½</strong></p>
                    <p style="font-size: 0.9em; margin-top: 8px;">ä¸ºäº†æ¥æ”¶åƒè¯æé†’ï¼Œè¯·å…è®¸æµè§ˆå™¨å‘é€é€šçŸ¥</p>
                    <p id="iosHint" style="font-size: 0.85em; margin-top: 8px; color: #856404; display: none;">
                        ğŸ’¡ iOSæç¤ºï¼šiOS 16.4+æ”¯æŒåå°é€šçŸ¥ã€‚å¦‚æœæ‚¨çš„ç³»ç»Ÿç‰ˆæœ¬è¾ƒä½ï¼Œè¯·ä¿æŒé¡µé¢æ‰“å¼€ä»¥è·å¾—æé†’ã€‚
                    </p>
                    <button class="btn" onclick="requestNotificationPermission()" style="margin-top: 12px;">å…è®¸é€šçŸ¥</button>
                </div>

                <form id="medicineForm">
                    <div class="form-group">
                        <label>è¯ç‰©åç§° *</label>
                        <input type="text" id="medicineName" required placeholder="ä¾‹å¦‚ï¼šé˜¿å¸åŒ¹æ—">
                    </div>

                    <div class="form-group">
                        <label>è¯ç‰©ç…§ç‰‡</label>
                        <div class="camera-container">
                            <video id="video" autoplay playsinline webkit-playsinline muted style="display: none;"></video>
                            <canvas id="canvas"></canvas>
                            <img id="photoPreview" class="photo-preview" alt="è¯ç‰©ç…§ç‰‡">
                            <p id="videoHint" style="display: none; font-size: 0.85em; color: #666; margin: 10px 0;">
                                ğŸ’¡ å¦‚æœè§†é¢‘æ˜¾ç¤ºä¸ºé»‘è‰²ï¼Œè¯·ç‚¹å‡»è§†é¢‘åŒºåŸŸå¼€å§‹é¢„è§ˆ
                            </p>
                            <div class="btn-group">
                                <button type="button" class="btn" onclick="startCamera()">ğŸ“· æ‰“å¼€æ‘„åƒå¤´</button>
                                <button type="button" class="btn btn-secondary" onclick="capturePhoto()" id="captureBtn" style="display: none;">ğŸ“¸ æ‹ç…§</button>
                                <button type="button" class="btn btn-secondary" onclick="stopCamera()" id="stopBtn" style="display: none;">åœæ­¢</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æ¯æ—¥æœç”¨æ¬¡æ•° *</label>
                        <select id="timesPerDay" required>
                            <option value="1">1æ¬¡</option>
                            <option value="2">2æ¬¡</option>
                            <option value="3">3æ¬¡</option>
                            <option value="4">4æ¬¡</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>æ¯æ¬¡æœç”¨å‰‚é‡ *</label>
                        <input type="text" id="dosage" required placeholder="ä¾‹å¦‚ï¼š1ç‰‡ã€5ml">
                    </div>

                    <div class="form-group">
                        <label>æé†’æ—¶é—´ *</label>
                        <div id="reminderTimes"></div>
                        <button type="button" class="btn btn-secondary" onclick="addReminderTime()" style="margin-top: 10px; width: 100%;">+ æ·»åŠ æé†’æ—¶é—´</button>
                    </div>

                    <div class="form-group">
                        <label>å¤‡æ³¨</label>
                        <input type="text" id="notes" placeholder="ä¾‹å¦‚ï¼šé¥­åæœç”¨">
                    </div>

                    <button type="submit" class="btn">ä¿å­˜è¯ç‰©</button>
                </form>
            </div>

            <!-- æˆ‘çš„è¯ç‰©åˆ—è¡¨ -->
            <div id="list" class="tab-content">
                <div id="medicineList" class="medicine-list">
                    <div class="empty-state">
                        <p>æš‚æ— è¯ç‰©è®°å½•</p>
                    </div>
                </div>
            </div>

            <!-- ç”¨è¯è®°å½• -->
            <div id="records" class="tab-content">
                <div id="recordList" class="record-list">
                    <div class="empty-state">
                        <p>æš‚æ— ç”¨è¯è®°å½•</p>
                    </div>
                </div>
            </div>

            <!-- æé†’è®¾ç½® -->
            <div id="reminders" class="tab-content">
                <h2>æé†’è®¾ç½®</h2>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enableNotifications" onchange="toggleNotifications()">
                        å¯ç”¨æµè§ˆå™¨é€šçŸ¥
                    </label>
                </div>
                <div class="form-group">
                    <label>æé†’æå‰æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
                    <input type="number" id="reminderAdvance" min="0" value="5" onchange="saveReminderSettings()">
                </div>
                <div id="upcomingReminders"></div>
            </div>
        </div>
    </div>

    <script>
        // æ•°æ®åº“åˆå§‹åŒ–
        let db;
        const DB_NAME = 'MedicineReminderDB';
        const DB_VERSION = 1;

        // åˆå§‹åŒ–æ•°æ®åº“
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    db = event.target.result;

                    // è¯ç‰©è¡¨
                    if (!db.objectStoreNames.contains('medicines')) {
                        const medicineStore = db.createObjectStore('medicines', { keyPath: 'id', autoIncrement: true });
                        medicineStore.createIndex('name', 'name', { unique: false });
                    }

                    // ç”¨è¯è®°å½•è¡¨
                    if (!db.objectStoreNames.contains('records')) {
                        const recordStore = db.createObjectStore('records', { keyPath: 'id', autoIncrement: true });
                        recordStore.createIndex('medicineId', 'medicineId', { unique: false });
                        recordStore.createIndex('timestamp', 'timestamp', { unique: false });
                    }

                    // è®¾ç½®è¡¨
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }
                };
            });
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName, element) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (element) {
                element.classList.add('active');
            } else {
                // å¦‚æœæ²¡æœ‰ä¼ å…¥elementï¼Œé€šè¿‡tabNameæ‰¾åˆ°å¯¹åº”çš„tab
                document.querySelectorAll('.tab').forEach(tab => {
                    if (tab.textContent.includes(getTabText(tabName))) {
                        tab.classList.add('active');
                    }
                });
            }
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'list') {
                loadMedicines();
            } else if (tabName === 'records') {
                loadRecords();
            } else if (tabName === 'reminders') {
                loadUpcomingReminders();
            }
        }

        function getTabText(tabName) {
            const map = {
                'add': 'æ·»åŠ è¯ç‰©',
                'list': 'æˆ‘çš„è¯ç‰©',
                'records': 'ç”¨è¯è®°å½•',
                'reminders': 'æé†’è®¾ç½®'
            };
            return map[tabName] || '';
        }

        // æ‘„åƒå¤´ç›¸å…³
        let stream = null;
        let capturedPhoto = null;

        function startCamera() {
            const video = document.getElementById('video');
            
            // ç§»åŠ¨ç«¯ç‰¹æ®Šå¤„ç†ï¼šç¡®ä¿è§†é¢‘å…ƒç´ å±æ€§æ­£ç¡®
            video.setAttribute('playsinline', 'true');
            video.setAttribute('webkit-playsinline', 'true');
            video.muted = true; // ç§»åŠ¨ç«¯è¦æ±‚è‡ªåŠ¨æ’­æ”¾éœ€è¦é™éŸ³
            video.playsInline = true;
            
            // Androidç‰¹æ®Šä¼˜åŒ–
            if (isAndroid) {
                // Androidé€šå¸¸å¯¹æ‘„åƒå¤´æ”¯æŒæ›´å¥½ï¼Œå¯ä»¥è®¾ç½®æ›´é«˜çš„åˆ†è¾¨ç‡
                video.setAttribute('autoplay', 'true');
            }
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶æ¥è§¦å‘æ’­æ”¾ï¼ˆiOSå¯èƒ½éœ€è¦ç”¨æˆ·äº¤äº’ï¼‰
            const handleVideoClick = () => {
                if (video.paused && stream) {
                    video.play()
                        .then(() => {
                            const hint = document.getElementById('videoHint');
                            if (hint) {
                                hint.style.display = 'none';
                            }
                        })
                        .catch(err => {
                            console.log('ç‚¹å‡»æ’­æ”¾å¤±è´¥:', err);
                        });
                }
            };
            video.addEventListener('click', handleVideoClick);
            
            // ç›‘å¬æ’­æ”¾çŠ¶æ€
            video.addEventListener('play', () => {
                video.classList.add('playing');
                video.classList.remove('paused');
                const hint = document.getElementById('videoHint');
                if (hint) {
                    hint.style.display = 'none';
                }
            });
            
            video.addEventListener('pause', () => {
                video.classList.add('paused');
                video.classList.remove('playing');
            });
            
            // ç§»åŠ¨ç«¯ä¼˜å…ˆä½¿ç”¨åç½®æ‘„åƒå¤´
            const constraints = {
                video: {
                    facingMode: { ideal: 'environment' }, // åç½®æ‘„åƒå¤´
                    // Androidå¯ä»¥æ”¯æŒæ›´é«˜åˆ†è¾¨ç‡
                    width: { ideal: isAndroid ? 1920 : 1280 },
                    height: { ideal: isAndroid ? 1080 : 720 }
                }
            };

            navigator.mediaDevices.getUserMedia(constraints)
                .then(mediaStream => {
                    stream = mediaStream;
                    video.srcObject = mediaStream;
                    
                    // iOSéœ€è¦ç­‰å¾…loadedmetadataäº‹ä»¶
                    const handleLoadedMetadata = () => {
                        video.style.display = 'block';
                        document.getElementById('captureBtn').style.display = 'inline-block';
                        document.getElementById('stopBtn').style.display = 'inline-block';
                        
                        // å°è¯•è‡ªåŠ¨æ’­æ”¾
                        const playPromise = video.play();
                        if (playPromise !== undefined) {
                            playPromise
                                .then(() => {
                                    console.log('è§†é¢‘è‡ªåŠ¨æ’­æ”¾æˆåŠŸ');
                                    video.classList.add('playing');
                                })
                                .catch(err => {
                                    console.log('è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œç­‰å¾…ç”¨æˆ·äº¤äº’:', err);
                                    // iOSå¯èƒ½éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾
                                    // æ˜¾ç¤ºæç¤ºæˆ–ç­‰å¾…ç”¨æˆ·ç‚¹å‡»
                                    video.classList.add('paused');
                                    const hint = document.getElementById('videoHint');
                                    // iOSå’Œéƒ¨åˆ†Androidè®¾å¤‡å¯èƒ½éœ€è¦ç”¨æˆ·äº¤äº’
                                    if (hint && (isIOS || isAndroid)) {
                                        hint.style.display = 'block';
                                    }
                                });
                        }
                    };
                    
                    // ä½¿ç”¨å¤šä¸ªäº‹ä»¶ç¡®ä¿è§¦å‘
                    const tryPlay = () => {
                        if (video.readyState >= 1 && video.videoWidth > 0) {
                            handleLoadedMetadata();
                        }
                    };
                    
                    video.addEventListener('loadedmetadata', tryPlay, { once: true });
                    video.addEventListener('loadeddata', tryPlay, { once: true });
                    video.addEventListener('canplay', tryPlay, { once: true });
                    
                    // å¦‚æœå·²ç»å‡†å¤‡å¥½ï¼Œç«‹å³æ‰§è¡Œ
                    setTimeout(() => {
                        if (video.readyState >= 1 && video.videoWidth > 0 && video.style.display === 'none') {
                            handleLoadedMetadata();
                        }
                    }, isAndroid ? 200 : 100); // Androidå¯èƒ½éœ€è¦ç¨é•¿çš„ç­‰å¾…æ—¶é—´
                })
                .catch(err => {
                    // å¦‚æœåç½®æ‘„åƒå¤´å¤±è´¥ï¼Œå°è¯•å‰ç½®æ‘„åƒå¤´
                    if (err.name === 'NotReadableError' || err.name === 'NotFoundError' || err.name === 'NotAllowedError') {
                        // Androidå¯èƒ½å› ä¸ºæƒé™é—®é¢˜å¤±è´¥ï¼Œä¹Ÿå°è¯•å‰ç½®æ‘„åƒå¤´
                        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
                            .then(mediaStream => {
                                stream = mediaStream;
                                video.srcObject = mediaStream;
                                
                                const handleLoadedMetadata = () => {
                                    video.style.display = 'block';
                                    document.getElementById('captureBtn').style.display = 'inline-block';
                                    document.getElementById('stopBtn').style.display = 'inline-block';
                                    
                                    const playPromise = video.play();
                                    if (playPromise !== undefined) {
                                        playPromise
                                            .then(() => {
                                                console.log('è§†é¢‘æ’­æ”¾æˆåŠŸ');
                                                video.classList.add('playing');
                                            })
                                            .catch(e => {
                                                console.log('æ’­æ”¾å¤±è´¥ï¼Œç­‰å¾…ç”¨æˆ·äº¤äº’:', e);
                                                video.classList.add('paused');
                                            });
                                    }
                                };
                                
                                const tryPlay = () => {
                                    if (video.readyState >= 1 && video.videoWidth > 0) {
                                        handleLoadedMetadata();
                                    }
                                };
                                
                                video.addEventListener('loadedmetadata', tryPlay, { once: true });
                                video.addEventListener('loadeddata', tryPlay, { once: true });
                                video.addEventListener('canplay', tryPlay, { once: true });
                                
                                setTimeout(() => {
                                    if (video.readyState >= 1 && video.videoWidth > 0 && video.style.display === 'none') {
                                        handleLoadedMetadata();
                                    }
                                }, isAndroid ? 200 : 100); // Androidå¯èƒ½éœ€è¦ç¨é•¿çš„ç­‰å¾…æ—¶é—´
                            })
                            .catch(e => {
                                const errorMsg = isAndroid ? 
                                    'æ— æ³•è®¿é—®æ‘„åƒå¤´ã€‚è¯·æ£€æŸ¥ï¼š\n1. æ˜¯å¦æˆäºˆäº†æ‘„åƒå¤´æƒé™\n2. æ˜¯å¦æœ‰å…¶ä»–åº”ç”¨æ­£åœ¨ä½¿ç”¨æ‘„åƒå¤´\n3. æµè§ˆå™¨æ˜¯å¦æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½' :
                                    'æ— æ³•è®¿é—®æ‘„åƒå¤´: ' + e.message;
                                alert(errorMsg);
                            });
                    } else {
                        alert('æ— æ³•è®¿é—®æ‘„åƒå¤´: ' + err.message);
                    }
                });
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const preview = document.getElementById('photoPreview');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            capturedPhoto = canvas.toDataURL('image/png');
            preview.src = capturedPhoto;
            preview.style.display = 'block';
        }

        function stopCamera() {
            const video = document.getElementById('video');
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            if (video.srcObject) {
                video.srcObject = null;
            }
            video.style.display = 'none';
            video.classList.remove('playing', 'paused');
            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'none';
            const hint = document.getElementById('videoHint');
            if (hint) {
                hint.style.display = 'none';
            }
        }

        // æé†’æ—¶é—´ç®¡ç†
        let reminderTimeCount = 0;

        function addReminderTime() {
            reminderTimeCount++;
            const container = document.getElementById('reminderTimes');
            const div = document.createElement('div');
            div.className = 'form-group';
            div.style.marginBottom = '10px';
            div.style.display = 'flex';
            div.style.gap = '10px';
            div.style.alignItems = 'center';
            div.innerHTML = `
                <input type="time" id="reminderTime${reminderTimeCount}" required style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()" style="width: auto; min-width: 80px; margin: 0; padding: 12px 16px;">åˆ é™¤</button>
            `;
            container.appendChild(div);
        }

        // ä¿å­˜è¯ç‰©
        document.getElementById('medicineForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const reminderTimes = [];
            document.querySelectorAll('[id^="reminderTime"]').forEach(input => {
                if (input.value) {
                    reminderTimes.push(input.value);
                }
            });

            if (reminderTimes.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªæé†’æ—¶é—´');
                return;
            }

            const medicine = {
                name: document.getElementById('medicineName').value,
                photo: capturedPhoto || null,
                timesPerDay: parseInt(document.getElementById('timesPerDay').value),
                dosage: document.getElementById('dosage').value,
                reminderTimes: reminderTimes,
                notes: document.getElementById('notes').value,
                createdAt: new Date().toISOString()
            };

            try {
                const transaction = db.transaction(['medicines'], 'readwrite');
                const store = transaction.objectStore('medicines');
                await store.add(medicine);
                
                alert('è¯ç‰©ä¿å­˜æˆåŠŸï¼');
                document.getElementById('medicineForm').reset();
                document.getElementById('photoPreview').style.display = 'none';
                capturedPhoto = null;
                document.getElementById('reminderTimes').innerHTML = '';
                reminderTimeCount = 0;
                stopCamera();
                
                // è®¾ç½®æé†’
                setupReminders();
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        });

        // åŠ è½½è¯ç‰©åˆ—è¡¨
        async function loadMedicines() {
            try {
                const transaction = db.transaction(['medicines'], 'readonly');
                const store = transaction.objectStore('medicines');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const medicines = request.result;
                    const container = document.getElementById('medicineList');
                    
                    if (medicines.length === 0) {
                        container.innerHTML = '<div class="empty-state"><p>æš‚æ— è¯ç‰©è®°å½•</p></div>';
                        return;
                    }

                    container.innerHTML = medicines.map(medicine => `
                        <div class="medicine-card">
                            <h3>${medicine.name} <span class="reminder-badge">${medicine.timesPerDay}æ¬¡/å¤©</span></h3>
                            ${medicine.photo ? `<img src="${medicine.photo}" alt="${medicine.name}">` : ''}
                            <div class="info">
                                <p><strong>å‰‚é‡:</strong> ${medicine.dosage}</p>
                                <p><strong>æé†’æ—¶é—´:</strong> ${medicine.reminderTimes.join(', ')}</p>
                                ${medicine.notes ? `<p><strong>å¤‡æ³¨:</strong> ${medicine.notes}</p>` : ''}
                            </div>
                            <div class="actions">
                                <button class="btn" onclick="recordMedicine(${medicine.id})">âœ… è®°å½•å·²æœç”¨</button>
                                <button class="btn btn-danger" onclick="deleteMedicine(${medicine.id})">åˆ é™¤</button>
                            </div>
                        </div>
                    `).join('');
                };
            } catch (error) {
                console.error('åŠ è½½è¯ç‰©å¤±è´¥:', error);
            }
        }

        // è®°å½•ç”¨è¯
        async function recordMedicine(medicineId) {
            try {
                const transaction = db.transaction(['medicines'], 'readonly');
                const store = transaction.objectStore('medicines');
                const medicine = await new Promise((resolve, reject) => {
                    const request = store.get(medicineId);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                if (!medicine) {
                    alert('è¯ç‰©ä¸å­˜åœ¨');
                    return;
                }

                const record = {
                    medicineId: medicineId,
                    medicineName: medicine.name,
                    photo: medicine.photo,
                    timestamp: new Date().toISOString(),
                    dosage: medicine.dosage
                };

                const recordTransaction = db.transaction(['records'], 'readwrite');
                const recordStore = recordTransaction.objectStore('records');
                await recordStore.add(record);

                alert('ç”¨è¯è®°å½•å·²ä¿å­˜ï¼');
                loadRecords();
            } catch (error) {
                alert('è®°å½•å¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤è¯ç‰©
        async function deleteMedicine(medicineId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¯ç‰©å—ï¼Ÿ')) return;

            try {
                const transaction = db.transaction(['medicines'], 'readwrite');
                const store = transaction.objectStore('medicines');
                await store.delete(medicineId);
                
                alert('åˆ é™¤æˆåŠŸï¼');
                loadMedicines();
                setupReminders();
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½ç”¨è¯è®°å½•
        async function loadRecords() {
            try {
                const transaction = db.transaction(['records'], 'readonly');
                const store = transaction.objectStore('records');
                const index = store.index('timestamp');
                const request = index.openCursor(null, 'prev'); // å€’åº
                
                const records = [];
                request.onsuccess = (e) => {
                    const cursor = e.target.result;
                    if (cursor) {
                        records.push(cursor.value);
                        cursor.continue();
                    } else {
                        displayRecords(records);
                    }
                };
            } catch (error) {
                console.error('åŠ è½½è®°å½•å¤±è´¥:', error);
            }
        }

        function displayRecords(records) {
            const container = document.getElementById('recordList');
            
            if (records.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>æš‚æ— ç”¨è¯è®°å½•</p></div>';
                return;
            }

            container.innerHTML = records.map(record => {
                const date = new Date(record.timestamp);
                return `
                    <div class="record-item">
                        <h4>${record.medicineName}</h4>
                        <p class="time">${date.toLocaleString('zh-CN')}</p>
                        <p><strong>å‰‚é‡:</strong> ${record.dosage}</p>
                        ${record.photo ? `<img src="${record.photo}" alt="${record.medicineName}">` : ''}
                    </div>
                `;
            }).join('');
        }

        // é€šçŸ¥æƒé™
        async function requestNotificationPermission() {
            if ('Notification' in window) {
                try {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        document.getElementById('notificationPermission').style.display = 'none';
                        await saveSetting('notificationsEnabled', true);
                        
                        // è®¾å¤‡ç‰¹å®šæç¤º
                        if (isIOS) {
                            alert('âœ… é€šçŸ¥æƒé™å·²æˆäºˆï¼\n\næç¤ºï¼š\n- iOS 16.4+ æ”¯æŒåå°é€šçŸ¥\n- è¯·ä¿æŒé¡µé¢åœ¨åå°è¿è¡Œ\n- æˆ–å°†æ­¤é¡µé¢æ·»åŠ åˆ°ä¸»å±å¹•ä»¥è·å¾—æ›´å¥½çš„ä½“éªŒ');
                        } else if (isAndroid) {
                            alert('âœ… é€šçŸ¥æƒé™å·²æˆäºˆï¼\n\nAndroidè®¾å¤‡æ”¯æŒå®Œæ•´çš„åå°é€šçŸ¥åŠŸèƒ½ï¼Œå³ä½¿åº”ç”¨åœ¨åå°ä¹Ÿèƒ½æ”¶åˆ°æé†’ã€‚');
                        }
                        
                        // æ³¨å†ŒService Workerä»¥æ”¯æŒåå°é€šçŸ¥
                        await registerServiceWorker();
                        await setupReminders();
                    } else if (permission === 'denied') {
                        const deviceHint = isAndroid ? 
                            'è¯·åœ¨æµè§ˆå™¨è®¾ç½® > ç½‘ç«™è®¾ç½® > é€šçŸ¥ä¸­å…è®¸é€šçŸ¥æƒé™ã€‚' : 
                            'è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸é€šçŸ¥æƒé™ã€‚';
                        alert('é€šçŸ¥æƒé™è¢«æ‹’ç»ã€‚' + deviceHint);
                    }
                } catch (error) {
                    console.error('è¯·æ±‚é€šçŸ¥æƒé™å¤±è´¥:', error);
                    alert('è¯·æ±‚é€šçŸ¥æƒé™å¤±è´¥: ' + error.message);
                }
            } else {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥åŠŸèƒ½ã€‚');
            }
        }

        // ä¿å­˜è®¾ç½®
        async function saveSetting(key, value) {
            try {
                const transaction = db.transaction(['settings'], 'readwrite');
                const store = transaction.objectStore('settings');
                await store.put({ key, value });
            } catch (error) {
                console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
            }
        }

        // è·å–è®¾ç½®
        async function getSetting(key, defaultValue) {
            try {
                const transaction = db.transaction(['settings'], 'readonly');
                const store = transaction.objectStore('settings');
                const request = store.get(key);
                return new Promise((resolve) => {
                    request.onsuccess = () => {
                        resolve(request.result ? request.result.value : defaultValue);
                    };
                    request.onerror = () => resolve(defaultValue);
                });
            } catch (error) {
                return defaultValue;
            }
        }

        // æé†’åŠŸèƒ½
        let reminderIntervals = [];
        let originalTitle = document.title;
        let titleBlinkInterval = null;
        let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        let isAndroid = /Android/.test(navigator.userAgent);
        let lastReminderTimes = {}; // è®°å½•ä¸Šæ¬¡æé†’çš„æ—¶é—´ï¼Œé˜²æ­¢é‡å¤

        // æ³¨å†ŒService Workerï¼ˆç”¨äºiOS 16.4+å’ŒAndroidåå°é€šçŸ¥ï¼‰
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    // åˆ›å»ºService Workerä»£ç 
                    const swCode = `
                        self.addEventListener('message', (event) => {
                            if (event.data && event.data.type === 'SHOW_NOTIFICATION') {
                                const { title, body, icon, tag } = event.data;
                                const options = {
                                    body: body,
                                    tag: tag,
                                    requireInteraction: false,
                                    silent: false,
                                    vibrate: [200, 100, 200] // Androidéœ‡åŠ¨
                                };
                                
                                // æ·»åŠ å›¾æ ‡ï¼ˆå¦‚æœæ”¯æŒï¼‰
                                if (icon) {
                                    options.icon = icon;
                                    options.badge = icon;
                                }
                                
                                self.registration.showNotification(title, options);
                            }
                        });
                        
                        // Android: å¤„ç†é€šçŸ¥ç‚¹å‡»
                        self.addEventListener('notificationclick', (event) => {
                            event.notification.close();
                            event.waitUntil(
                                clients.openWindow('/')
                            );
                        });
                    `;
                    
                    const blob = new Blob([swCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(blob);
                    
                    const registration = await navigator.serviceWorker.register(swUrl);
                    console.log('Service Workeræ³¨å†ŒæˆåŠŸ');
                    
                    // ç­‰å¾…Service Workeræ¿€æ´»
                    if (registration.installing) {
                        await new Promise((resolve) => {
                            registration.installing.addEventListener('statechange', () => {
                                if (registration.installing.state === 'activated') {
                                    resolve();
                                }
                            });
                        });
                    }
                    
                    return registration;
                } catch (error) {
                    console.log('Service Workeræ³¨å†Œå¤±è´¥:', error);
                    return null;
                }
            }
            return null;
        }

        async function setupReminders() {
            // æ¸…é™¤ç°æœ‰æé†’
            reminderIntervals.forEach(interval => clearInterval(interval));
            reminderIntervals = [];

            const notificationsEnabled = await getSetting('notificationsEnabled', false);
            if (!notificationsEnabled) {
                if (Notification.permission === 'default') {
                    document.getElementById('notificationPermission').style.display = 'block';
                }
                return;
            }

            // æ³¨å†ŒService Worker
            await registerServiceWorker();

            try {
                const transaction = db.transaction(['medicines'], 'readonly');
                const store = transaction.objectStore('medicines');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const medicines = request.result;
                    medicines.forEach(medicine => {
                        medicine.reminderTimes.forEach(time => {
                            const [hours, minutes] = time.split(':').map(Number);
                            
                            // ç«‹å³æ£€æŸ¥ä¸€æ¬¡ï¼ˆå¦‚æœæ—¶é—´å·²åˆ°ï¼‰
                            checkAndShowReminder(hours, minutes, medicine);
                            
                            // è®¾ç½®å®šæ—¶æ£€æŸ¥
                            const interval = setInterval(() => {
                                checkAndShowReminder(hours, minutes, medicine);
                            }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œæ›´ç²¾ç¡®
                            
                            reminderIntervals.push(interval);
                        });
                    });
                };
            } catch (error) {
                console.error('è®¾ç½®æé†’å¤±è´¥:', error);
            }
        }

        function checkAndShowReminder(hours, minutes, medicine) {
            const now = new Date();
            const reminderKey = `${medicine.id}-${hours}-${minutes}`;
            const lastReminderTime = lastReminderTimes[reminderKey];
            
            // æ£€æŸ¥æ˜¯å¦åœ¨ç›®æ ‡æ—¶é—´èŒƒå›´å†…ï¼ˆå‰30ç§’å†…ï¼‰
            if (now.getHours() === hours && now.getMinutes() === minutes && now.getSeconds() < 30) {
                // é˜²æ­¢é‡å¤æé†’ï¼šå¦‚æœä¸Šæ¬¡æé†’æ˜¯åœ¨åŒä¸€åˆ†é’Ÿå†…ï¼Œåˆ™ä¸é‡å¤æé†’
                if (!lastReminderTime || 
                    lastReminderTime.getHours() !== hours || 
                    lastReminderTime.getMinutes() !== minutes) {
                    lastReminderTimes[reminderKey] = new Date();
                    showReminder(medicine);
                }
            }
        }

        function showReminder(medicine) {
            const reminderText = `ğŸ’Š åƒè¯æé†’: ${medicine.name}`;
            const reminderBody = `è¯¥åƒ ${medicine.dosage} äº†${medicine.notes ? ' (' + medicine.notes + ')' : ''}`;
            
            // 1. å°è¯•ä½¿ç”¨Web Notification API
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    // Androidå’ŒiOS 16.4+ï¼šä¼˜å…ˆä½¿ç”¨Service Worker
                    if ('serviceWorker' in navigator) {
                        // ç­‰å¾…Service Workerå°±ç»ª
                        navigator.serviceWorker.ready.then(registration => {
                            registration.showNotification(reminderText, {
                                body: reminderBody,
                                icon: medicine.photo || undefined,
                                badge: medicine.photo || undefined,
                                tag: `medicine-${medicine.id}-${Date.now()}`,
                                requireInteraction: false,
                                vibrate: isAndroid ? [200, 100, 200] : undefined, // Androidéœ‡åŠ¨
                                silent: false
                            });
                        }).catch(() => {
                            // Service Workerå¤±è´¥ï¼Œå°è¯•ç›´æ¥é€šçŸ¥
                            try {
                                new Notification(reminderText, {
                                    body: reminderBody,
                                    icon: medicine.photo || undefined,
                                    tag: `medicine-${medicine.id}-${Date.now()}`,
                                    badge: medicine.photo || undefined,
                                    requireInteraction: false
                                });
                            } catch (e) {
                                console.log('é€šçŸ¥æ˜¾ç¤ºå¤±è´¥:', e);
                            }
                        });
                    } else {
                        // ç›´æ¥æ˜¾ç¤ºé€šçŸ¥ï¼ˆAndroid Chromeé€šå¸¸æ”¯æŒï¼‰
                        try {
                            const notificationOptions = {
                                body: reminderBody,
                                tag: `medicine-${medicine.id}-${Date.now()}`,
                                requireInteraction: false
                            };
                            
                            // æ·»åŠ å›¾æ ‡ï¼ˆå¦‚æœæ”¯æŒï¼‰
                            if (medicine.photo) {
                                notificationOptions.icon = medicine.photo;
                                notificationOptions.badge = medicine.photo;
                            }
                            
                            // Androidéœ‡åŠ¨
                            if (isAndroid) {
                                notificationOptions.vibrate = [200, 100, 200];
                            }
                            
                            new Notification(reminderText, notificationOptions);
                        } catch (e) {
                            console.log('é€šçŸ¥æ˜¾ç¤ºå¤±è´¥:', e);
                        }
                    }
                }
            }

            // 2. å¦‚æœé¡µé¢å¯è§ï¼Œä½¿ç”¨é¡µé¢æé†’
            if (!document.hidden) {
                // é¡µé¢æ ‡é¢˜é—ªçƒ
                startTitleBlink(reminderText);
                
                // æ’­æ”¾æç¤ºéŸ³ï¼ˆå¦‚æœå…è®¸ï¼‰
                playReminderSound();
                
                // æ˜¾ç¤ºé¡µé¢å†…æé†’
                showPageReminder(medicine);
            } else {
                // é¡µé¢åœ¨åå°ï¼Œä¿å­˜æé†’çŠ¶æ€
                savePendingReminder(medicine);
            }
        }

        function startTitleBlink(text) {
            if (titleBlinkInterval) return; // å·²ç»åœ¨é—ªçƒ
            
            let isBlink = false;
            titleBlinkInterval = setInterval(() => {
                document.title = isBlink ? originalTitle : text;
                isBlink = !isBlink;
            }, 1000);
            
            // 10ç§’ååœæ­¢é—ªçƒ
            setTimeout(() => {
                if (titleBlinkInterval) {
                    clearInterval(titleBlinkInterval);
                    titleBlinkInterval = null;
                    document.title = originalTitle;
                }
            }, 10000);
        }

        function playReminderSound() {
            try {
                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡æ’­æ”¾æç¤ºéŸ³
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('æ’­æ”¾å£°éŸ³å¤±è´¥:', e);
            }
        }

        function showPageReminder(medicine) {
            // åˆ›å»ºé¡µé¢å†…æé†’å¼¹çª—
            const reminderDiv = document.createElement('div');
            reminderDiv.id = 'pageReminder';
            reminderDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px 30px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 10000;
                text-align: center;
                max-width: 90%;
                animation: slideDown 0.3s ease-out;
            `;
            
            reminderDiv.innerHTML = `
                <h3 style="margin: 0 0 10px 0; font-size: 1.2em;">ğŸ’Š åƒè¯æé†’</h3>
                <p style="margin: 0 0 10px 0; font-size: 1.1em; font-weight: bold;">${medicine.name}</p>
                <p style="margin: 0 0 15px 0;">è¯¥åƒ ${medicine.dosage} äº†${medicine.notes ? '<br>' + medicine.notes : ''}</p>
                <button onclick="this.parentElement.remove()" style="
                    background: white;
                    color: #667eea;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 8px;
                    font-weight: bold;
                    cursor: pointer;
                ">çŸ¥é“äº†</button>
            `;
            
            document.body.appendChild(reminderDiv);
            
            // 10ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (reminderDiv.parentElement) {
                    reminderDiv.remove();
                }
            }, 10000);
        }

        function savePendingReminder(medicine) {
            // ä¿å­˜å¾…å¤„ç†çš„æé†’ï¼Œå½“ç”¨æˆ·æ‰“å¼€é¡µé¢æ—¶æ˜¾ç¤º
            const pendingReminders = JSON.parse(localStorage.getItem('pendingReminders') || '[]');
            pendingReminders.push({
                medicine: medicine.name,
                dosage: medicine.dosage,
                notes: medicine.notes,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('pendingReminders', JSON.stringify(pendingReminders));
        }

        // æ£€æŸ¥å¾…å¤„ç†çš„æé†’
        function checkPendingReminders() {
            if (document.hidden) return;
            
            const pendingReminders = JSON.parse(localStorage.getItem('pendingReminders') || '[]');
            if (pendingReminders.length > 0) {
                pendingReminders.forEach(reminder => {
                    const medicine = {
                        name: reminder.medicine,
                        dosage: reminder.dosage,
                        notes: reminder.notes
                    };
                    showPageReminder(medicine);
                });
                localStorage.removeItem('pendingReminders');
            }
        }

        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                checkPendingReminders();
                if (titleBlinkInterval) {
                    clearInterval(titleBlinkInterval);
                    titleBlinkInterval = null;
                    document.title = originalTitle;
                }
            }
        });

        function toggleNotifications() {
            const enabled = document.getElementById('enableNotifications').checked;
            saveSetting('notificationsEnabled', enabled);
            if (enabled) {
                requestNotificationPermission();
            }
        }

        function saveReminderSettings() {
            const advance = parseInt(document.getElementById('reminderAdvance').value);
            saveSetting('reminderAdvance', advance);
        }

        async function loadUpcomingReminders() {
            const enabled = await getSetting('notificationsEnabled', false);
            document.getElementById('enableNotifications').checked = enabled;
            
            const advance = await getSetting('reminderAdvance', 5);
            document.getElementById('reminderAdvance').value = advance;

            try {
                const transaction = db.transaction(['medicines'], 'readonly');
                const store = transaction.objectStore('medicines');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const medicines = request.result;
                    const container = document.getElementById('upcomingReminders');
                    
                    if (medicines.length === 0) {
                        container.innerHTML = '<p>æš‚æ— æé†’è®¾ç½®</p>';
                        return;
                    }

                    const now = new Date();
                    const upcoming = [];
                    
                    medicines.forEach(medicine => {
                        medicine.reminderTimes.forEach(time => {
                            const [hours, minutes] = time.split(':').map(Number);
                            const reminderTime = new Date();
                            reminderTime.setHours(hours, minutes, 0, 0);
                            
                            if (reminderTime < now) {
                                reminderTime.setDate(reminderTime.getDate() + 1);
                            }
                            
                            upcoming.push({
                                medicine: medicine.name,
                                time: reminderTime,
                                dosage: medicine.dosage
                            });
                        });
                    });

                    upcoming.sort((a, b) => a.time - b.time);

                    container.innerHTML = '<h3 style="margin-top: 20px;">å³å°†åˆ°æ¥çš„æé†’</h3>' +
                        upcoming.slice(0, 10).map(item => `
                            <div class="record-item">
                                <h4>${item.medicine}</h4>
                                <p><strong>æ—¶é—´:</strong> ${item.time.toLocaleString('zh-CN')}</p>
                                <p><strong>å‰‚é‡:</strong> ${item.dosage}</p>
                            </div>
                        `).join('');
                };
            } catch (error) {
                console.error('åŠ è½½æé†’å¤±è´¥:', error);
            }
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            await initDB();
            await loadMedicines();
            
            // æ£€æŸ¥å¾…å¤„ç†çš„æé†’
            checkPendingReminders();
            
            // æ£€æŸ¥é€šçŸ¥æƒé™
            const notificationsEnabled = await getSetting('notificationsEnabled', false);
            if (notificationsEnabled) {
                await setupReminders();
            } else {
                if ('Notification' in window) {
                    if (Notification.permission === 'default') {
                        const permissionDiv = document.getElementById('notificationPermission');
                        if (permissionDiv) {
                            permissionDiv.style.display = 'block';
                            // å¦‚æœæ˜¯iOSè®¾å¤‡ï¼Œæ˜¾ç¤ºç‰¹æ®Šæç¤º
                            if (isIOS) {
                                const iosHint = document.getElementById('iosHint');
                                if (iosHint) {
                                    iosHint.style.display = 'block';
                                }
                            } else if (isAndroid) {
                                // Androidè®¾å¤‡æç¤º
                                const iosHint = document.getElementById('iosHint');
                                if (iosHint) {
                                    iosHint.innerHTML = 'ğŸ’¡ Androidæç¤ºï¼šAndroidè®¾å¤‡æ”¯æŒå®Œæ•´çš„åå°é€šçŸ¥åŠŸèƒ½ï¼Œå³ä½¿åº”ç”¨å…³é—­ä¹Ÿèƒ½æ”¶åˆ°æé†’ã€‚';
                                    iosHint.style.display = 'block';
                                }
                            }
                        }
                    } else if (Notification.permission === 'granted') {
                        // æƒé™å·²æˆäºˆä½†è®¾ç½®æœªå¯ç”¨ï¼Œè‡ªåŠ¨å¯ç”¨
                        await saveSetting('notificationsEnabled', true);
                        await setupReminders();
                    }
                } else {
                    // ä¸æ”¯æŒé€šçŸ¥ï¼Œæ˜¾ç¤ºæç¤º
                    const permissionDiv = document.getElementById('notificationPermission');
                    if (permissionDiv) {
                        permissionDiv.innerHTML = '<p><strong>ğŸ“± æé†’åŠŸèƒ½</strong></p><p style="font-size: 0.9em; margin-top: 8px;">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥åŠŸèƒ½ã€‚ç³»ç»Ÿå°†ä½¿ç”¨é¡µé¢å†…æé†’å’Œå£°éŸ³æé†’ã€‚</p>';
                        permissionDiv.style.display = 'block';
                    }
                }
            }
            
            // ä¿å­˜åŸå§‹æ ‡é¢˜
            originalTitle = document.title;
        });

        // é¡µé¢è·å¾—ç„¦ç‚¹æ—¶æ£€æŸ¥æé†’
        window.addEventListener('focus', () => {
            checkPendingReminders();
        });
    </script>
</body>
</html>
